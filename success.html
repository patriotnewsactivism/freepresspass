<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout Success - Free Press Pass</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://sites.super.myninja.ai/_assets/ninja-daytona-script.js"></script>
  <style>
    .success-container {
      text-align: center;
      padding: 2rem;
      background-color: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin: 2rem auto;
      max-width: 800px;
    }
    
    .success-icon {
      color: #4CAF50;
      font-size: 4rem;
      margin-bottom: 1rem;
    }
    
    .order-details {
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      margin: 1.5rem 0;
      text-align: left;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .order-details h3 {
      margin-top: 0;
      border-bottom: 1px solid #eee;
      padding-bottom: 0.5rem;
    }
    
    .detail-row {
      display: flex;
      justify-content: space-between;
      margin: 0.5rem 0;
    }
    
    .detail-label {
      font-weight: bold;
      color: #555;
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0,0,0,.1);
      border-radius: 50%;
      border-top-color: #4CAF50;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .status-message {
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
    }
    
    .status-success {
      background-color: #e8f5e9;
      color: #2e7d32;
      border-left: 4px solid #4CAF50;
    }
    
    .status-error {
      background-color: #ffebee;
      color: #c62828;
      border-left: 4px solid #f44336;
    }
    
    .status-pending {
      background-color: #fff8e1;
      color: #f57f17;
      border-left: 4px solid #ffc107;
    }
    
    .action-buttons {
      margin-top: 2rem;
    }
    
    .action-buttons button {
      margin: 0 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>FREE PRESS PASS</h1>
  </header>
  
  <main>
    <div class="success-container">
      <div class="success-icon">âœ“</div>
      <h2>Order Successful!</h2>
      
      <div class="status-message status-success">
        <p>Thank you for your purchase. Your payment has been processed successfully.</p>
      </div>
      
      <div class="order-details">
        <h3>Order Details</h3>
        <div id="order-loading">
          <span class="loading"></span> Loading order details...
        </div>
        <div id="order-content" style="display: none;">
          <div class="detail-row">
            <span class="detail-label">Order ID:</span>
            <span id="order-id">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Name:</span>
            <span id="order-name">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Press Pass ID:</span>
            <span id="pass-id">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Amount:</span>
            <span id="order-amount">$15.00</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Status:</span>
            <span id="order-status">Paid</span>
          </div>
        </div>
      </div>
      
      <div class="shipping-info">
        <h3>What's Next?</h3>
        <p>Your laminated press pass will be shipped within 3-5 business days.</p>
        <p>You can continue to use your digital press pass in the meantime.</p>
      </div>
      
      <div id="database-status" class="status-message status-pending">
        <span class="loading"></span> Verifying database record...
      </div>
      
      <div class="action-buttons">
        <button onclick="window.location.href='index.html'">Generate Another Pass</button>
        <button id="download-pass" disabled>Download Digital Pass</button>
      </div>
    </div>
  </main>
  
  <footer>
    <p>This journalist is recognized under the protections of the First Amendment of the U.S. Constitution. Any interference will be a violation of federal law.</p>
    <p>Do not hinder, exclude, or block the view of this journalist in the exercise of court-recognized First Amendment rights.</p>
  </footer>
  
  <script type="module">
    import { fetchPasses } from './api.js';
    
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');
    const passId = urlParams.get('pass_id');
    
    // Display order details
    document.getElementById('order-id').textContent = sessionId || 'N/A';
    document.getElementById('pass-id').textContent = passId || 'N/A';
    
    // Function to verify database record
    async function verifyDatabaseRecord() {
      try {
        if (!passId) {
          updateDatabaseStatus('error', 'No pass ID provided. Unable to verify database record.');
          return;
        }
        
        // Fetch all passes and find the one matching our pass ID
        const passes = await fetchPasses();
        const ourPass = passes.data.find(pass => pass.pass_number === passId);
        
        if (ourPass) {
          // Update order details
          document.getElementById('order-name').textContent = ourPass.full_name || 'N/A';
          document.getElementById('order-status').textContent = ourPass.paid ? 'Paid' : 'Processing';
          
          // Show order content
          document.getElementById('order-loading').style.display = 'none';
          document.getElementById('order-content').style.display = 'block';
          
          // Enable download button
          document.getElementById('download-pass').disabled = false;
          
          // Update database status
          updateDatabaseStatus('success', 'Your press pass has been successfully stored in our database.');
        } else {
          updateDatabaseStatus('error', 'Your press pass was not found in our database. Please contact support.');
        }
      } catch (error) {
        console.error('Error verifying database record:', error);
        updateDatabaseStatus('error', 'Error verifying database record: ' + error.message);
      }
    }
    
    // Update database status message
    function updateDatabaseStatus(status, message) {
      const statusElement = document.getElementById('database-status');
      statusElement.className = `status-message status-${status}`;
      statusElement.innerHTML = message;
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', () => {
      // Verify database record
      verifyDatabaseRecord();
      
      // Set up download button
      document.getElementById('download-pass').addEventListener('click', () => {
        // Redirect to index page with pass ID to regenerate the pass
        window.location.href = `index.html?regenerate=${passId}`;
      });
    });
  </script>
</body>
</html>